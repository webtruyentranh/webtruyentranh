<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}Website Truy·ªán{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>
<header class="main-header">
  <div class="nav-top">
    <div class="nav-left">
      <a href="{{ url_for('index') }}" class="logo">
        <img src="{{ url_for('static', filename='img/logoset.png') }}" alt="Logo">
      </a>
    </div>

    <form class="search-bar" action="{{ url_for('page_search') }}" method="get">
      <input type="text" name="q" placeholder="T√¨m ki·∫øm ·ªü trang hi·ªán t·∫°i..." value="{{ request.args.get('q', '') }}">
      <button type="submit"><i class="fa fa-search"></i></button>
    </form>

    <div class="nav-right">
      <!-- üîî N√∫t chu√¥ng + H·ªôp th√¥ng b√°o -->
<div class="bell-container" style="position: relative;">
  <i id="notifBell" class="fa fa-bell bell"></i>
  <span id="notifCount"
        style="display:none;position:absolute;top:-8px;right:-8px;
               background:#ff4d4f;color:#fff;font-size:12px;
               padding:2px 6px;border-radius:50%;">
  </span>

  <!-- H·ªôp th√¥ng b√°o -->
  <div id="notifDropdown" class="notify-box">
    <div class="notify-header">
      <span>üìú L·ªãch s·ª≠ theo d√µi</span>
      <button id="markAllRead">ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc</button>
    </div>
    <div id="notifList" class="notify-list"></div>
    <div id="notifEmpty" style="color:#aaa;text-align:center;padding:10px;">
      Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o
    </div>
  </div>
</div>

{% if session.get('user_id') %}
<div class="user-dropdown-container">
  <div class="user-avatar" onclick="toggleUserDropdown()">
    <img id="userAvatarBase"
      src="{{ session.get('avatar_url') if session.get('avatar_url') else url_for('static', filename='img/default-avatar.png') }}"
      alt="Avatar">
  </div>

  <div id="userDropdown" class="user-dropdown">
    <div class="user-info">
<img id="userAvatarDropdown"
     src="{{ session.get('avatar_url') if session.get('avatar_url') else url_for('static', filename='img/default-avatar.png') }}"
     alt="Avatar nh·ªè">
      <div>
        <b>{{ session.get('username', 'Ng∆∞·ªùi d√πng') }}</b><br>
        <small style="color:#ccc;">{{ session.get('email', 'Ch∆∞a c·∫≠p nh·∫≠t email') }}</small>
      </div>
    </div>
    <hr>

    <a href="{{ url_for('profile_page') }}"><i class="fa-solid fa-user-pen"></i> Ch·ªânh s·ª≠a trang c√° nh√¢n</a>

    {% if session.get('role') == 'admin' %}
      <a href="{{ url_for('admin.add_comic') }}"><i class="fa-solid fa-square-plus"></i> T·∫°o truy·ªán m·ªõi</a>
    {% endif %}

    <!-- <a href="{{ url_for('following_page') }}"><i class="fa-solid fa-bookmark"></i> Truy·ªán ƒëang theo d√µi</a>
    <a href="/lich-su"><i class="fa-solid fa-clock-rotate-left"></i> L·ªãch s·ª≠ ƒë·ªçc truy·ªán</a>
    <a href="/liked"><i class="fa-solid fa-heart"></i> Truy·ªán ƒë√£ th√≠ch</a> -->
    <a href="{{ url_for('logout') }}"><i class="fa-solid fa-right-from-bracket"></i> ƒêƒÉng xu·∫•t</a>
  </div>
</div>
{% else %}
  <a href="{{ url_for('login') }}">
    <img id="userAvatarBase"
      src="{{ url_for('static', filename='img/default-avatar.png') }}" alt="Avatar" class="avatar">
  </a>
{% endif %}

    </div>
  </div>
  <nav class="navbar">


   <ul>
<li><a href="{{ url_for('index') }}">Trang Ch·ªß</a></li>

    <li class="dropdown">
  <a href="#">Th·ªÉ lo·∫°i ‚ñæ</a>
  <div class="dropdown-content mega-menu">
    {% for g in genres %}
      <a href="/the-loai/{{ g.slug }}">{{ g.name }}</a>
    {% endfor %}
    
    
  </div>
</li>


    <li class="dropdown">
  <a href="#">X·∫øp H·∫°ng ‚ñæ</a>
  <div class="dropdown-content sub-menu">
    <a href="/xep-hang/xem">Top L∆∞·ª£t Xem</a>
    <a href="/xep-hang/thich">Top Y√™u Th√≠ch</a>
    <a href="/xep-hang/theo-doi">Top Theo D√µi</a>
    <a href="/xep-hang/danh-gia">Top ƒê√°nh Gi√°</a>
    <a href="/xep-hang/ngay">Top Ng√†y</a>
    <a href="/xep-hang/tuan">Top Tu·∫ßn</a>
    <a href="/xep-hang/thang">Top Th√°ng</a>
    <a href="/xep-hang/tat-ca">Top T·ªïng Th·ªÉ</a>
  </div>
</li>

    <li>
      <a href="/lich-su"
         class="{% if '/lich-su' in request.path %}active{% endif %}">
         L·ªãch s·ª≠
      </a>
    </li>

    <li>
      <a href="/following"
         class="{% if '/following' in request.path %}active{% endif %}">
         Theo d√µi
      </a>
    </li>

    <li>
      <a href="/liked"
         class="{% if '/liked' in request.path %}active{% endif %}">
         Y√™u th√≠ch
      </a>
    </li>

    <li>
      <a href="{{ url_for('thaoluan') }}"
         class="{% if '/thaoluan' in request.path %}active{% endif %}">
         Th·∫£o lu·∫≠n
      </a>
    </li>

    <li>
      <a href="{{ url_for('fanpage') }}"
         class="{% if '/fanpage' in request.path %}active{% endif %}">
         Fanpage
      </a>
    </li>

    <li>
      <a href="{{ url_for('request_translate') }}"
         class="{% if '/yeu-cau-dich' in request.path %}active{% endif %}">
         Y√™u c·∫ßu d·ªãch truy·ªán
      </a>
    </li>

    {% if session.get('role') == 'admin' %}
    <li>
      <a href="{{ url_for('admin.manage_all_comics') }}"
         class="{% if '/admin/manage_all_comics' in request.path %}active{% endif %}">
         Qu·∫£n l√Ω truy·ªán
      </a>
    </li>
    <li>
      <a href="{{ url_for('admin.manage_genres') }}"
         class="{% if '/admin/manage_genres' in request.path %}active{% endif %}">
         Qu·∫£n l√Ω th·ªÉ lo·∫°i
      </a>
    </li>
    <li><a href="{{ url_for('admin.add_comic') }}">T·∫°o truy·ªán m·ªõi</a></li>

    {% endif %}
  </ul>

</nav>

</header>
<!-- PH·∫¶N N·ªòI DUNG RI√äNG -->
<main>
  
  {% block content %}{% endblock %}
</main>

<!-- üß© SCRIPT TH√îNG B√ÅO -->
<script>
const notifBell = document.getElementById('notifBell');
const notifCount = document.getElementById('notifCount');
const notifDropdown = document.getElementById('notifDropdown');
const notifList = document.getElementById('notifList');
const notifEmpty = document.getElementById('notifEmpty');

// üü¢ L·∫•y danh s√°ch th√¥ng b√°o t·ª´ Flask
async function loadNotifications() {
  try {
    const res = await fetch('/notifications');
    const data = await res.json();
    notifList.innerHTML = '';

    if (!data || data.length === 0) {
      notifEmpty.textContent = 'Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o.';
      notifEmpty.style.display = 'block';
      return;
    }

    notifEmpty.style.display = 'none';
    data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
    .forEach(item => {
      const time = new Date(item.created_at).toLocaleString('vi-VN', {
        hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit'
      });
      const div = document.createElement('div');
      div.style.borderBottom = '1px solid #333';
      div.style.padding = '6px 0';
      div.innerHTML = `
        <span style="color:${item.message.includes('theo d√µi') ? '#22c55e' : '#ef4444'};">
          ${item.message}
        </span><br>
        <small style="color:#999;">${time}</small>
      `;
      notifList.appendChild(div);
    });
  } catch (err) {
    console.error('L·ªói khi t·∫£i th√¥ng b√°o:', err);
    notifEmpty.textContent = 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu.';
  }
}

// üü° ƒê·∫øm s·ªë th√¥ng b√°o ch∆∞a ƒë·ªçc
async function loadUnreadCount() {
  try {
    const res = await fetch('/notifications/unread-count');
    const data = await res.json();
    if (data.count > 0) {
      notifCount.textContent = data.count;
      notifCount.style.display = 'inline-block';
    } else {
      notifCount.style.display = 'none';
    }
  } catch (e) {
    console.error('L·ªói khi t·∫£i s·ªë ch∆∞a ƒë·ªçc:', e);
  }
}

// üîî X·ª≠ l√Ω khi nh·∫•n chu√¥ng
notifBell.addEventListener('click', async (e) => {
  e.stopPropagation();
  if (notifDropdown.style.display === 'none') {
    notifDropdown.style.display = 'block';
    await loadNotifications();
    await fetch('/notifications/mark-read', { method: 'POST' });
    notifCount.style.display = 'none';
  } else {
    notifDropdown.style.display = 'none';
  }
});

// ·∫®n dropdown khi click ra ngo√†i
document.addEventListener('click', (e) => {
  if (!notifDropdown.contains(e.target) && e.target !== notifBell) {
    notifDropdown.style.display = 'none';
  }
});

// üïí T·ª± c·∫≠p nh·∫≠t s·ªë ƒë·ªè m·ªói 10 gi√¢y
loadUnreadCount();
setInterval(loadUnreadCount, 10000);
</script>
<script>
function toggleUserDropdown() {
  const menu = document.getElementById('userDropdown');
  menu.classList.toggle('show');
}

document.addEventListener('click', (e) => {
  const menu = document.getElementById('userDropdown');
  const avatar = document.querySelector('.user-avatar img');
  if (menu && !menu.contains(e.target) && e.target !== avatar) {
    menu.classList.remove('show');
  }
});
</script>

<!-- DEBUG + CSS -->
{% if request.args.get('debug') == '1' %}
  <div class="debug-role">Role hi·ªán t·∫°i: {{ current_role }}</div>
{% endif %}

<style>
  .user-dropdown-container {
  position: relative;
  display: inline-block;
}

.user-avatar img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 2px solid #444;
  cursor: pointer;
  object-fit: cover;
  transition: 0.2s;
}
.user-avatar img:hover { border-color: #ff4444; transform: scale(1.05); }

.user-dropdown {
  display: none;
  position: absolute;
  right: 0;
  top: 50px;
  background: #0f1419;
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.5);
  width: 260px;
  z-index: 9999;
  overflow: hidden;
  animation: slideDown 0.2s ease;
}

.user-dropdown.show {
  display: block;
}

.user-dropdown a {
  display: block;
  color: #ddd;
  text-decoration: none;
  padding: 10px 16px;
  font-size: 15px;
  transition: 0.2s;
}
.user-dropdown a:hover {
  background: rgba(255,255,255,0.08);
  color: #fff;
}

.user-dropdown i {
  margin-right: 10px;
  width: 18px;
  color: #ffffff;
}

.user-info {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  gap: 10px;
}

.user-info img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.main-header {
  background: #111;
  width: 100%;
  top: 0;
  position: fixed;
  z-index: 1000;
}

.nav-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 40px;
  background: #0d0d0d;
  box-shadow: 0 2px 6px rgba(0, 0, 0, .4);
}

.logo img { height: 40px; display: block; }

.search-bar {
  flex: 1;
  max-width: 600px;
  display: flex;
  align-items: center;
  background: #1e1e1e;
  border-radius: 20px;
  margin: 0 30px;
  overflow: hidden;
}

.search-bar input {
  flex: 1;
  padding: 8px 14px;
  border: none;
  outline: none;
  background: transparent; 
  color: #fff;
  font-size: 15px;
}

.search-bar button {
  background: #dc2626;
  border: none;
  color: #fff;
  padding: 8px 14px;
  cursor: pointer;
  transition: 0.2s;
  border-radius: 0 20px 20px 0;
}
.search-bar button:hover { background: #ef4444; }

.nav-right { display: flex; align-items: center; gap: 18px; }
.bell { font-size: 20px; color: #ccc; cursor: pointer; transition: 0.2s; }
.bell:hover { color: white; transform: scale(1.1); }

.avatar {
  width: 38px; height: 38px; border-radius: 50%;
  border: 2px solid #444; object-fit: cover; transition: 0.2s;
}
.avatar:hover { border-color: #dc2626; transform: scale(1.1); }

.navbar {
  background: #1a1a1a;
  padding: 8px 0;
  border-top: 1px solid #222;
}
.navbar ul {
  list-style: none; margin: 0; padding: 0;
  display: flex; justify-content: center; gap: 28px;
}
.navbar a {
  color: #ccc; text-decoration: none; font-weight: 500; transition: 0.2s;
}
.navbar a:hover, .navbar a.active { color: #ff4444; }
body {
  padding-top: 105px; /* ƒêi·ªÅu ch·ªânh l·∫°i ƒë·ªÉ kh·ªõp v·ªõi 60px (nav-top) + ~45px (navbar) */
  background:#000;
  color:#fff;
  /* (Gi·ªØ min-height: 1000px; ƒë·ªÉ ƒë·∫£m b·∫£o thanh cu·ªôn lu√¥n xu·∫•t hi·ªán) */
  min-height: 1000px;
}

/* ==== C·∫¢I TI·∫æN GIAO DI·ªÜN KHUNG TH√îNG B√ÅO ==== */
.notify-box {
  background: #0b0f13 !important; /* n·ªÅn t·ªëi ƒë·ªìng b·ªô */
  color: #fff !important;
  font-size: 16px !important; /* ch·ªØ to h∆°n */
  font-family: "Segoe UI", sans-serif;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
}

.notify-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: #111820;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  font-weight: bold;
  color: #fff;
  font-size: 17px;
}

.notify-header button {
  background: #fff;
  color: #000;
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.2s;
  font-weight: 600;
}
.notify-header button:hover {
  background: #dc2626;
  color: #fff;
}

.notify-list {
  max-height: 400px;
  overflow-y: auto;
  color: #fff !important;
  font-size: 16px;
  line-height: 1.6;
  padding: 10px;
}

.notify-list div {
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  padding: 8px 0;
  transition: 0.2s;
}

.notify-list div:hover {
  background: rgba(255, 255, 255, 0.08);
}

.notify-list span {
  color: #fff !important;
  font-size: 16px;
}

.notify-list small {
  color: #ccc !important;
  font-size: 14px;
}

#notifEmpty {
  color: #aaa !important;
  font-size: 15px;
  text-align: center;
  padding: 10px;
}
/* ====== TH√îNG B√ÅO & L·ªäCH S·ª¨ THEO D√ïI (ƒê√É CH·ªàNH M√ÄU) ====== */
.notify-box {
  position: absolute;
  top: 60px;
  right: 20px;
  width: 380px;
  max-height: 480px;
  background: #0d1117; /* n·ªÅn t·ªëi xanh ƒëen h√†i h√≤a */
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 12px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.65);
  overflow-y: auto;
  color: #e6edf3;
  font-family: "Segoe UI", sans-serif;
  display: none;
  z-index: 1000;
  backdrop-filter: blur(4px);
}

.notify-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: #161b22; /* xanh ƒëen m·ªù */
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  font-weight: 600;
  color: #fff;
}

.notify-header span {
  color: #fff;
  font-size: 15px;
}

.notify-header button {
  background: #000000; /* xanh l√° ki·ªÉu GitHub */
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 13px;
  font-weight: 600;
}
.notify-header button:hover {
  background: #2ea043; /* s√°ng h∆°n khi hover */
}

/* Danh s√°ch th√¥ng b√°o */
.notify-list {
  max-height: 400px;
  overflow-y: auto;
  background: #0d1117;
}

.notify-item {
  display: flex;
  align-items: flex-start;
  padding: 10px 14px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.06);
  transition: background 0.2s, transform 0.1s;
}
.notify-item:hover {
  background: rgba(56, 139, 253, 0.08);
  transform: translateX(3px);
}

.notify-item.unread {
  background: rgba(37, 99, 235, 0.08);
}

.notify-item .icon {
  font-size: 18px;
  color: #58a6ff; /* xanh lam t∆∞∆°i */
  margin-right: 10px;
  line-height: 1;
  margin-top: 2px;
}

.notify-item .text {
  flex: 1;
  color: #c9d1d9;
}

.notify-item .text b {
  color: #f0f6fc;
}

.notify-item .time {
  font-size: 12px;
  color: #8b949e;
  margin-top: 4px;
}

/* Thanh cu·ªôn t√πy ch·ªânh */
.notify-list::-webkit-scrollbar {
  width: 6px;
}
.notify-list::-webkit-scrollbar-thumb {
  background: #30363d;
  border-radius: 4px;
}

/* Hi·ªáu ·ª©ng tr∆∞·ª£t m∆∞·ª£t */
@keyframes slideDown {
  from { opacity: 0; transform: translateY(-15px); }
  to   { opacity: 1; transform: translateY(0); }
}
.notify-box.show {
  display: block;
  animation: slideDown 0.25s ease forwards;
}

/* Hi·ªáu ·ª©ng chu√¥ng khi c√≥ th√¥ng b√°o m·ªõi */
#notifyButton.has-unread {
  color: #ff4444;
  animation: blink 1.2s infinite alternate;
}
@keyframes blink {
  from { filter: brightness(1); }
  to   { filter: brightness(1.8); }
}
body {
    min-height: 1000px; /* Th√™m chi·ªÅu cao t·ªëi thi·ªÉu l·ªõn ƒë·ªÉ ƒë·∫£m b·∫£o thanh cu·ªôn xu·∫•t hi·ªán */
}
</style>



</body>
<script>
const userAvatarBase = document.getElementById('userAvatarBase');

function renderAvatar(user){
  if(user && user.avatar_url){
    userAvatarBase.src = user.avatar_url;
  } else if (userAvatarBase) {
    // C√≥ th·ªÉ c·∫ßn x·ª≠ l√Ω l·∫°i ·∫£nh m·∫∑c ƒë·ªãnh
    userAvatarBase.src = '{{ url_for("static", filename="img/default-avatar.png") }}';
  }
}

/* L·∫•y tr·∫°ng th√°i khi t·∫£i trang */
(async ()=>{
  const res = await fetch('/api/me');
  const data = await res.json();
  renderAvatar(data.user);
})();
const userAvatarDropdown = document.getElementById('userAvatarDropdown');

function renderAvatar(user){
  const url = user && user.avatar_url ? user.avatar_url : '{{ url_for("static", filename="img/default-avatar.png") }}';
  if (userAvatarBase) userAvatarBase.src = url;
  if (userAvatarDropdown) userAvatarDropdown.src = url;
}

</script>
</html>
